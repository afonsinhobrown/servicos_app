{% extends "base.html" %}

{% block title %}Conversa - Servi√ßosPro{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 80vh;
        display: flex;
        flex-direction: column;
    }
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    .message {
        max-width: 70%;
        margin-bottom: 1rem;
    }
    .message.sent {
        margin-left: auto;
        background: #007bff;
        color: white;
        border-radius: 18px 18px 4px 18px;
    }
    .message.received {
        margin-right: auto;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 18px 18px 18px 4px;
    }
    .message-content {
        padding: 12px 16px;
    }
    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-0">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm chat-container">
                <!-- Cabe√ßalho CORRIGIDO -->
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{{ url_for('chat.index') }}" class="btn btn-outline-secondary btn-sm me-3">
                                <i class="bi bi-arrow-left"></i>
                            </a>
                            <div>
                                <h6 class="fw-bold mb-0">
                                    {% if current_user.tipo == 'cliente' %}
                                    Conversa com {{ prestador_usuario.nome if prestador_usuario else 'Prestador' }}
                                    {% else %}
                                    Conversa com {{ cliente.nome if cliente else 'Cliente' }}
                                    {% endif %}
                                </h6>
                                <small class="text-muted">
                                    {{ agendamento.servico.titulo if agendamento.servico else 'Servi√ßo' }} ‚Ä¢
                                    {{ agendamento.data_agendamento.strftime('%d/%m/%Y %H:%M') if agendamento.data_agendamento else 'Data n√£o definida' }}
                                </small>
                            </div>
                        </div>
                        <span class="badge bg-{% if agendamento.status == 'confirmado' %}success{% elif agendamento.status == 'pendente' %}warning{% else %}secondary{% endif %}">
                            {{ agendamento.status.title() if agendamento.status else 'Status' }}
                        </span>
                    </div>
                </div>

                <!-- √Årea de Mensagens -->
                <div class="messages-container" id="messagesContainer">
                    {% if mensagens %}
                        {% for mensagem in mensagens %}
                        <div class="message {% if mensagem.remetente_id == current_user.id %}sent{% else %}received{% endif %}">
                            <div class="message-content">
                                {{ mensagem.conteudo }}
                                <div class="message-time">
                                    {{ mensagem.data_envio.strftime('%H:%M') }}
                                    {% if mensagem.remetente_id == current_user.id %}
                                    <i class="bi bi-{% if mensagem.lida %}check2-all text-info{% else %}check2 text-muted{% endif %} ms-1"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-quote display-1"></i>
                        <p class="mt-3">Nenhuma mensagem ainda</p>
                        <small>Envie a primeira mensagem para iniciar a conversa</small>
                    </div>
                    {% endif %}
                </div>

                <!-- Formul√°rio de Mensagem -->
                <div class="border-top bg-white p-3">
                    <form id="messageForm">
                        <div class="input-group">
                            <input type="text"
                                   class="form-control"
                                   id="messageInput"
                                   placeholder="Digite sua mensagem..."
                                   required>
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const conversaId = {{ conversa.id }};
const currentUserId = {{ current_user.id }};

// Fun√ß√£o para enviar mensagem
async function enviarMensagem(mensagemTexto) {
    try {
        console.log(`üì§ Enviando mensagem: "${mensagemTexto}" para conversa ${conversaId}`);

        const response = await fetch('/chat/api/enviar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                conversa_id: conversaId,
                mensagem: mensagemTexto
            })
        });

        const data = await response.json();

        if (data.success) {
            console.log('‚úÖ Mensagem enviada com sucesso:', data);
            return true;
        } else {
            console.error('‚ùå Erro ao enviar mensagem:', data.error);
            alert('Erro ao enviar mensagem: ' + data.error);
            return false;
        }
    } catch (error) {
        console.error('‚ùå Erro de rede:', error);
        alert('Erro de conex√£o. Tente novamente.');
        return false;
    }
}

// Fun√ß√£o para carregar mensagens
async function carregarMensagens() {
    try {
        const response = await fetch(`/chat/api/mensagens/${conversaId}`);
        const data = await response.json();

        if (data.success) {
            atualizarInterfaceMensagens(data.mensagens);
        } else {
            console.error('Erro ao carregar mensagens:', data.error);
        }
    } catch (error) {
        console.error('Erro ao carregar mensagens:', error);
    }
}

// Fun√ß√£o para atualizar a interface com as mensagens
function atualizarInterfaceMensagens(mensagens) {
    const container = document.getElementById('messagesContainer');

    // Limpar container
    container.innerHTML = '';

    if (mensagens.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-quote display-1"></i>
                <p class="mt-3">Nenhuma mensagem ainda</p>
                <small>Envie a primeira mensagem para iniciar a conversa</small>
            </div>
        `;
        return;
    }

    mensagens.forEach(mensagem => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${mensagem.remetente_id === currentUserId ? 'sent' : 'received'}`;

        messageDiv.innerHTML = `
            <div class="message-content">
                ${mensagem.conteudo.replace(/\n/g, '<br>')}
                <div class="message-time">
                    ${new Date(mensagem.data_envio).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                    ${mensagem.remetente_id === currentUserId ?
                        `<i class="bi bi-${mensagem.lida ? 'check2-all text-info' : 'check2 text-muted'} ms-1"></i>` :
                        ''}
                </div>
            </div>
        `;

        container.appendChild(messageDiv);
    });

    // Rolagem autom√°tica para a √∫ltima mensagem
    container.scrollTop = container.scrollHeight;
}

// Event listener para o formul√°rio
document.getElementById('messageForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const messageInput = document.getElementById('messageInput');
    const mensagemTexto = messageInput.value.trim();

    if (!mensagemTexto) return;

    // Desabilitar input temporariamente
    messageInput.disabled = true;
    const submitButton = this.querySelector('button');
    const originalText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';

    // Enviar mensagem
    const sucesso = await enviarMensagem(mensagemTexto);

    // Reabilitar input
    messageInput.disabled = false;
    submitButton.disabled = false;
    submitButton.innerHTML = originalText;

    if (sucesso) {
        // Limpar input
        messageInput.value = '';

        // Recarregar mensagens
        setTimeout(() => {
            carregarMensagens();
        }, 500);
    }
});

// Carregar mensagens automaticamente a cada 3 segundos
setInterval(carregarMensagens, 3000);

// Carregar mensagens quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    carregarMensagens();

    // Focar no input de mensagem
    document.getElementById('messageInput').focus();
});

// Permitir enviar com Enter
document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('messageForm').dispatchEvent(new Event('submit'));
    }
});
</script>
{% endblock %}